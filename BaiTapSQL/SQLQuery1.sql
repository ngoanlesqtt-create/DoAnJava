create DATABASE BAITAP1

USE BAITAP1
set dateformat dmy




--THAY DOI KIỀU DỮ LIỆU CỦA DVT
ALTER TABLE SANPHAM ALTER COLUMN DVT VARCHAR(50)
ALTER TABLE SANPHAM ADD CONSTRAINT CK_DVT CHECK (DVT='CAY' OR DVT='HOP' OR DVT='CAI' OR DVT='QUYEN' OR DVT='CHUC')
ALTER TABLE SANPHAM ADD CONSTRAINT CK_GIA CHECK (GIA>500)

--THAY ĐỔI KIỂU DỮ LIỆU SODT
ALTER TABLE KHACHHANG ALTER COLUMN SODT VARCHAR(50)
ALTER TABLE NHANVIEN ALTER COLUMN SODT VARCHAR(50)

--THAY ĐỔI KIỂU DỮ LIỆU CỦA DOANHSO
ALTER TABLE KHACHHANG ALTER COLUMN DOANHSO MONEY

--I.1.Tạo các quan hệ và khai báo các khóa chính, khóa ngoại của quan hệ.
CREATE TABLE KHACHHANG(
MAKH CHAR(4) PRIMARY KEY,
HOTEN VARCHAR(50),
DCHI VARCHAR(50),
SODT INT,
NGSINH DATETIME,
DOANHSO INT,
NGDK DATETIME
)
CREATE TABLE NHANVIEN(
MANV CHAR(4) PRIMARY KEY,
HOTEN VARCHAR(50),
NGVL DATETIME,
SODT INT
)
CREATE TABLE SANPHAM(
MASP CHAR(4) PRIMARY KEY,
TENSP VARCHAR(50),
DVT INT,
NUOCSX VARCHAR(50),
GIA MONEY
)
CREATE TABLE HOADON(
SOHD CHAR(4) PRIMARY KEY,
NGHD DATETIME,
MAKH CHAR(4) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
MANV CHAR(4) FOREIGN KEY REFERENCES NHANVIEN(MANV),
TRIGIA MONEY
)
CREATE TABLE CTHD(
SOHD CHAR(4) FOREIGN KEY REFERENCES HOADON(SOHD),
MASP CHAR(4) FOREIGN KEY REFERENCES SANPHAM(MASP),
SL INT,
CONSTRAINT PK_CTHD PRIMARY KEY(SOHD,MASP)
)
--I.2.Thêm vào thuộc tính GHICHU có kiểu dữ liệu varchar(20) cho quan hệ SANPHAM.
alteR TABLE SANPHAM ADD GHICHU VARCHAR(50)
--I.3.Thêm vào thuộc tính LOAIKH có kiểu dữ liệu là tinyint cho quan hệ KHACHHANG
ALTER TABLE KHACHHANG ADD LOAIKH TINYINT
--I.4.Sửa kiểu dữ liệu của thuộc tính GHICHU trong quan hệ SANPHAM thành varchar(100).
ALTER TABLE SANPHAM ALTER COLUMN GHICHU VARCHAR(100)
--I.5.Xóa thuộc tính GHICHU trong quan hệ SANPHAM
ALTER TABLE SANPHAM DROP COLUMN GHICHU
--I.6.Làm thế nào để thuộc tính LOAIKH trong quan hệ KHACHHANG có thể lưu các giá trị là: “Vang lai”, “Thuong xuyen”, “Vip”, …
ALTER TABLE KHACHHANG ALTER COLUMN LOAIKH VARCHAR(100)
--I.9.KHACH HANG PhAI MUA IT NHAT MOT SAN PHAM
ALTER TABLE CTHD ADD CONSTRAINT CK_SL CHECK (SL>=1)
--I.10.NGAY KHACH HANG DANG KY THANH VIEN PHAI LON HON NGAY SINH
ALTER TABLE KHACHHANG ADD CONSTRAINT CK_NGDK CHECK (GETDATE(NGSINH)>GETDATE(NGDK))
--11. Ngày mua hàng (NGHD) của một khách hàng thành viên sẽ lớn hơn hoặc bằng ngày khách hàng đó đăng ký thành viên (NGDK).
alter table 
--II.1.Nhập dữ liệu cho các quan hệ trên.
--THÊM DU LIEU NHÂN VIÊN
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV01', 'Nguyen Nhu Nhut', '0927345678', '13/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV02', 'Le Thi Phi Yen', '0987567390', '21/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV03', 'Nguyen Van B', '0997047382', '27/4/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV04', 'Ngo Thanh Tuan', '0913758498', '24/6/2006')
INSERT INTO NHANVIEN (MANV, HOTEN, SODT, NGVL) VALUES ('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '20/7/2006')
--THEM DU LIEU SAN PHAM
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC01', 'But Chi', 'cay', 'Singapore', 3000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC02', 'But Chi', 'cay', 'Singapore', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC03', 'But Chi', 'cay', 'Viet Nam', 3500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BC04', 'But Chi', 'hop', 'Viet Nam', 30000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST04', 'So tay', 'quyen', 'Thai Lan', 55000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM (MASP, TENSP, DVT, NUOCSX, GIA) VALUES ('ST10', 'But long', 'cay', 'Trung Quoc', 7000)
--THEM DU LIEU HOA DON
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1001, '23/07/2006', 'KH01', 'NV01', 320000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1002, '12/08/2006', 'KH01', 'NV02', 840000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1003, '23/06/2006', 'KH02', 'NV01', 100000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1004, '01/09/2006', 'KH02', 'NV01', 180000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1005, '20/10/2006', 'KH01', 'NV02', 3800000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1006, '16/10/2006', 'KH01', 'NV03', 2430000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1007, '28/10/2006', 'KH03', 'NV03', 510000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1008, '28/10/2006', 'KH01', 'NV03', 440000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1009, '28/10/2006', 'KH03', 'NV04', 320000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1010, '01/11/2006', 'KH01', 'NV01', 5200000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1011, '04/11/2006', 'KH04', 'NV03', 250000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1012, '30/11/2006', 'KH05', 'NV03', 21000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1013, '12/12/2006', 'KH06', 'NV01', 5000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1014, '31/12/2006', 'KH03', 'NV02', 3150000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1015, '01/01/2007', 'KH06', 'NV01', 910000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1016, '01/01/2007', 'KH07', 'NV02', 12500)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1017, '02/01/2007', 'KH08', 'NV03', 35000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1018, '13/01/2007', 'KH08', 'NV03', 330000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1019, '13/01/2007', 'KH01', 'NV03', 30000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1020, '14/01/2007', 'KH09', 'NV04', 70000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1021, '16/01/2007', 'KH10', 'NV03', 67500)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1022, '16/01/2007', NULL, 'NV03', 7000)
INSERT INTO HOADON (SOHD, NGHD, MAKH, MANV, TRIGIA) VALUES (1023, '17/01/2007', NULL, 'NV01', 330000)
--THEM DU LIEU KHACH HANG
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH01', 'Nguyen Van A', '731, Tran Hung Dao, Q5, TPHCM', '08823451', '22/10/1960', 13060000, '22/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '03/04/1974', 280000, '30/07/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '12/06/1980', 3860000, '05/08/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH04', 'Tran Minh Long', '50/34 Le Dai hanh, Q10, TpHCM', '0917325476', '09/03/1965', 250000, '02/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TPHCM', '08246108', '10/03/1960', 21000, '28/10/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '31/12/1981', 915000, '24/11/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '06/04/1971', 12500, '01/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TPHCM', '0938435756', '10/01/1971', 365000, '13/12/2006')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TPHCM', '08654763', '03/09/1979', 70000, '14/01/2007')
INSERT INTO KHACHHANG (MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TPHCM', '08768904', '02/05/1963', 67500, '16/01/2007')

--THEM DU LIEU VAO CTHD
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'ST01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'BC01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'BC02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1001, 'ST08', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BC04', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB01', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1002, 'BB02', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1003, 'BB03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV01', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1004, 'TV04', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1005, 'TV05', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1005, 'TV06', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'TV07', 20)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'ST01', 30)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1006, 'ST02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1007, 'ST03', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1008, 'ST04', 8)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1009, 'ST05', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'TV07', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST07', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST08', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'ST04', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1010, 'TV03', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1011, 'ST06', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1012, 'ST07', 3)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1013, 'ST08', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BC02', 80)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BB02', 100)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BC04', 60)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1014, 'BB01', 50)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1015, 'BB02', 30)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1015, 'BB03', 7)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1016, 'TV01', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV02', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV03', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1017, 'TV04', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1018, 'ST04', 6)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1019, 'ST05', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1019, 'ST06', 2)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1020, 'ST07', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'ST08', 5)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'TV01', 7)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1021, 'TV02', 10)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1022, 'ST07', 1)
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1023, 'ST04', 6)

--THEM THUOC TINH MANV VA TRI GIA CHO HOADON
ALTER TABLE HOADON ADD TRIGIA MONEY
ALTER TABLE HOADON ADD MANV CHAR(4)
ALTER TABLE HOADON ADD CONSTRAINT FK_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

--II.3.Cập nhập giá trị tăng 5% do Thái Lan sản xuất
update SANPHAM
SET GIA=GIA*0.05+GIA
WHERE NUOCSX='THAI LAN'
--II.4.CAP NHAP GIA GIAM 5% VOI NHUNG SAN PHAM DO TRUNG QUOC SAN XUAT CO GIA 10.000 TRO XUONG
UPDATE SANPHAM
SET GIA=GIA-GIA*0.05
WHERE NUOCSX='TRUNG QUOC' AND GIA<=10000
--II.5.CAP NHAP LOAIKH LA VIP  DOI VOI KHACH HANG DANG KI TRUOC NGAY 1/1/2007 CO DOANH SO TU 10.000.000 TRO LEN HOAC KHACH HANG DANG KI 
--TU 1/1/2007 TRO VE SAU CO DOANH SO 2.000.000 TRO LEN
UPDATE	KHACHHANG
SET LOAIKH='VIP'
WHERE (NGDK<'1/1/2007' AND DOANHSO>=10000000) OR(NGDK>='1/1/2007' AND DOANHSO>=2000000)
--III.1.IN RA SAN PHAM DO TRUNG QUOC SAN XUAT
SELECT MASP,TENSP
FROM SANPHAM
WHERE NUOCSX='TRUNG QUOC'
--III.2.IN RA SAN PHAM CO DON VI LA CAY, QUYEN
SELECT MASP,TENSP
FROM SANPHAM
WHERE DVT='CAY' OR DVT='QUYEN'
--III.3.IN RA MASP, TENSP BAT DAU BANG CHU B KET THUC LA 01
SELECT MASP,TENSP
FROM SANPHAM
WHERE MASP LIKE 'B%01'
--III.4.IN RA SAN PHAM TRUNG QUOC CO GIA TU 30000 DEN 40000
SELECT *
FROM SANPHAM
WHERE NUOCSX='TRUNG QUOC' AND GIA BETWEEN 30000 AND 40000
--III.5.IN RA SAN PHAM DO TRUNG QUOC HOAC THAI LAN CO GIA TU 30000 DEN 40000
SELECT *
FROM SANPHAM
WHERE (NUOCSX='TRUNG QUOC' AND GIA BETWEEN 30000 AND 40000) OR (NUOCSX='THAI LAN' AND GIA BETWEEN 30000 AND 40000)
--III.6.IN RA SO HOA DON VA TRI GIA HOA DON TRONG NGAY 1/1/20077 HOAC 2/1/2007
SELECT SOHD,TRIGIA
FROM HOADON
WHERE NGHD='1/1/2007' OR NGHD='2/1/2007'
--III.7.IN RA SO HOA DON VA TRI GIA HOA DON DUOC BAN TRONG THANG 1/2007, SAP XEP THEO NGAY TANG DAN VA TRI GIA HOA DON GIAM DAN
SELECT *
FROM HOADON
WHERE MONTH(NGHD)='1' AND YEAR(NGHD)='2007'
ORDER BY NGHD ASC, TRIGIA DESC
--III.8.IN RA MAKH,HOTEN DA MUA HANG TRONG NGAY 1/1/2007
SELECT *
FROM KHACHHANG,HOADON
WHERE KHACHHANG.MAKH=HOADON.MAKH AND NGHD='1/1/2007'
--III.9.IN RA SO HOA DON VA TRI GI HOA DON DUOC NHAN VIEN 'NGYEN VAN B' LAP TRONG NGAY 28/10/2006
SELECT *
FROM NHANVIEN,HOADON
WHERE NHANVIEN.MANV=HOADON.MANV AND HOTEN='NGUYEN VAN B' AND NGHD='28/10/2006'
--III.10.IN RA MASP,TENSP DUOC KHACH HANG 'NGUYEN VAN A' MUA TRONG THANG '10/2006'
SELECT TENSP, CTHD.MASP
FROM KHACHHANG,HOADON,CTHD,SANPHAM
WHERE KHACHHANG.MAKH=HOADON.MAKH AND HOADON.SOHD=CTHD.SOHD AND CTHD.MASP=SANPHAM.MASP 
AND HOTEN='NGUYEN VAN A' AND MONTH(NGHD)='10' AND YEAR(NGHD)='2006'
--III.11.TIM CAC SO HOA DON MUA SAN PHAM 'BB01' HOAC 'BB02'
SELECT SOHD
FROM CTHD
WHERE MASP='BB01'
UNION
SELECT SOHD
FROM CTHD
WHERE MASP='BB02'
--III.12.TIM CAC SO HOA DON MUA SAN PHAM 'BB01' HOAC 'BB02' MOI SAN PHAM CO SO LUONG TU 10 DEN 20
SELECT SOHD
FROM CTHD
WHERE MASP='BB01' AND SL BETWEEN 10 AND 20
UNION
SELECT SOHD
FROM CTHD
WHERE MASP='BB02' AND SL BETWEEN 10 AND 20
-- III.13.TIM SO HOA DON MUA SAN PHAM 'BB01' VA 'BB02' MOI SAN PHAM CO SO LUONG TU 10 DEN 20
SELECT SOHD
FROM CTHD
WHERE MASP='BB01' AND SL BETWEEN 10 AND 20
INTERSECT
SELECT SOHD
FROM CTHD
WHERE MASP='BB02' AND SL BETWEEN 10 AND 20
--III.14.IN RA CAC SAN PHAM DO TRUNG QUOC SAN XUAT BAN DUOC TRONG NGAY 1/1/2007
SELECT SANPHAM.MASP, TENSP
FROM SANPHAM,CTHD,HOADON
WHERE SANPHAM.MASP=CTHD.MASP AND CTHD.SOHD=HOADON.SOHD AND NUOCSX='TRUNG QUOC' AND DAY(NGHD)='1' AND MONTH(NGHD)='1' AND YEAR(NGHD)='2007'
--III.15.IN RA SAN PHAM KHONG BAN DUOC
SELECT MASP,TENSP
FROM SANPHAM
EXCEPT
SELECT SANPHAM.MASP,TENSP
FROM SANPHAM,CTHD
WHERE SANPHAM.MASP=CTHD.MASP
--III.16.IN RA CAC SAN PHAM KHONG BAN DUOC TRONG NAM 2006
SELECT SANPHAM.MASP,TENSP
FROM SANPHAM
WHERE MASP NOT IN(
SELECT CTHD.MASP
FROM CTHD,HOADON,SANPHAM
WHERE SANPHAM.MASP=CTHD.MASP AND CTHD.SOHD=HOADON.SOHD AND YEAR(NGHD)='2006' )
--III.17.IN RA CAC SAN HAM KHONG BAN DUOC TRONG NAM 2006 DO TRUNG QUOC SAN XUAT
SELECT MASP,TENSP,NUOCSX
FROM SANPHAM 
WHERE NUOCSX='TRUNG QUOC'
EXCEPT
SELECT CTHD.MASP,TENSP,NUOCSX
FROM SANPHAM,CTHD,HOADON
WHERE SANPHAM.MASP=CTHD.MASP AND CTHD.SOHD=HOADON.SOHD AND YEAR(NGHD)='2006'
--III.18.Tim hoa don da mua tat ca san pham do Singapore san xuất
SELECT *
FROM HOADON
WHERE  NOT EXISTS(SELECT *
FROM SANPHAM
WHERE NUOCSX='SINGAPORE' AND NOT EXISTS (SELECT *
FROM CTHD
WHERE CTHD.MASP=SANPHAM.MASP AND HOADON.SOHD=CTHD.SOHD))
--III.19.Tìm hóa đơn trong năm 2006 đã mua ít nhất tất cả sản phẩm do singapore sản xuất
SELECT *
FROM HOADON
WHERE YEAR(NGHD)='2006' AND NOT EXISTS (SELECT *
FROM SANPHAM
WHERE NUOCSX='SINGAPORE' AND NOT EXISTS (SELECT *
FROM CTHD	
WHERE CTHD.MASP=SANPHAM.MASP AND CTHD.SOHD=HOADON.SOHD))
--III.20.CO BAO NHIEU HOA DON KHONG PHAI KHACH HANG DANG KI THANH VIEN MUA
SELECT COUNT(SOHD) AS KHACHHANGKHONGLATHANHVIEN
FROM HOADON
WHERE MAKH IS NULL
--III.21.CO BAO NHIEU SAN PHAM KHAC NHAU DUOC BAN TRONG NAM 2006
SELECT COUNT (DISTINCT MASP)
FROM CTHD,HOADON
WHERE CTHD.SOHD=HOADON.SOHD AND YEAR(NGHD)='2006'
--III.22.CHO BIET TRI GIA HOA DON CAO NHAT VA THAP NHAT
SELECT MAX(TRIGIA) CAONHAT,MIN(TRIGIA) THAPNHAT
FROM HOADON
--III.23.TRI GIA TRUNG BINH TAT CA SAN PHAM UOC BAN RA TRONG NAM 2006
SELECT AVG(TRIGIA)
FROM HOADON
WHERE YEAR(NGHD)='2006'
--III.24.TINH DOANH THU BAN HANG TRONG NAM 2006
SELECT SUM(TRIGIA)
FROM HOADON
WHERE YEAR(NGHD)='2006'
--III.25.TIM TRI GIA HOA DON CAO NHAT TRONG NAM 2006
SELECT MAX(TRIGIA)
FROM HOADON
WHERE YEAR(NGHD)='2006'
--III.26.IN RA KHACH HANG CO TRI GIA HOA DON CAO NHAT TRONG NAM 2006
select top 1 with ties sum(trigia) trigia,khachhang.makh,hoten
from khachhang,hoadon
where khachhang.makh=hoadon.makh and year(nghd)='2006'
group by khachhang.makh,  hoten
order by sum(trigia) desc
--III.27.IN RA DANH SACH 3 KHACH HANG CO DOANH SO CAO NHAT
SELECT  TOP 3 WITH TIES DOANHSO,MAKH,HOTEN
FROM KHACHHANG
ORDER BY DOANHSO DESC
--III.28.IN RA DANH SACH SAN PHAM CO GIA BANG 1 TRONG 3 MUC CAO NHAT
SELECT TOP 3 WITH TIES GIA,MASP,TENSP
FROM SANPHAM
ORDER BY GIA DESC 
--III.29.IN RA CAC SAN PHAM DO THAI LAN SAN XUAT CO GIA BANG 1 TRONG 3 MUC GIA CAO NHAT
SELECT *
FROM SANPHAM
WHERE NUOCSX='THAI LAN' AND GIA IN(
SELECT TOP 3 WITH TIES GIA
FROM SANPHAM
ORDER BY GIA DESC )
--III.30.IN RA 3 SAN PHAM DO TRUNG QUOC SAN XUAT CO GIA CAO NHAT
SELECT TOP 3 WITH TIES GIA, MASP,TENSP,NUOCSX
FROM SANPHAM
WHERE NUOCSX='TRUNG QUOC'
ORDER BY GIA DESC
--III.31.IN RA DANH SACH 3 KHACH HANG CO DOANH SO CAO NHAT
SELECT TOP 3 WITH TIES DOANHSO,MAKH,HOTEN
FROM KHACHHANG
ORDER BY DOANHSO DESC
--III.32.IN RA TONG SO SAN PHAM DO TRUNG QUOC SAN XUAT
SELECT COUNT(MASP)
FROM SANPHAM
WHERE NUOCSX='TRUNG QUOC'
--III.33.TINH SO SAN PHAM TUNG NUOC SAN XUAT
SELECT NUOCSX,COUNT(MASP) SOSANPHAM
FROM SANPHAM
GROUP BY NUOCSX
--III.34.VOI MOI NUOC, TIM GIA BAN CAO NHAT,THAP NHAT, TRUNG BINH CUA CAC SAN PHAM
SELECT NUOCSX,MAX(GIA) CAONHAT,MIN(GIA) THAPNHAT,AVG(GIA) TRUNGBINH
FROM SANPHAM
GROUP BY NUOCSX
--III.35.IN DOANH THU TUNG NGAY
SELECT nghd,SUM(TRIGIA)
FROM HOADON
GROUP BY NGHD
--III.36.TINH TONG SO LUONG TUNG SAN PHAM BAN RA TRONG 10/2006
SELECT MASP,SUM(SL) TONGSOLUONG
FROM CTHD,HOADON
WHERE CTHD.SOHD=HOADON.SOHD AND MONTH(NGHD)='10' AND YEAR(NGHD)='2006'
GROUP BY MASP
--III.37.TINH DOANH THU BAN HANG TRONG TUNG THANG
SELECT month(nghd) tháng,YEAR(NGHD) NAM,sum(trigia) trigia
FROM HOADON
GROUP BY MONTH(NGHD), YEAR(NGHD)
--III.38.Tim hoa don mua it nhat 4 san pham khac nhau
select sohd
from cthd
group by sohd
having count(distinct masp)>=4
--III.39.Tim hoa don mua 3 san pham khac nhau do Viet Nam san xuat
select sohd
from cthd,sanpham
where nuocsx='viet nam' and cthd.masp=sanpham.masp
group by cthd.sohd
having count(distinct cthd.masp)=3
--III.40.Tim khach hang co so lan mua hang nhieu nhat
select top 1 with ties count(sohd) solanmuahang,khachhang.makh,hoten
from khachhang,hoadon
where khachhang.makh=hoadon.makh
group by KHACHHANG.makh,hoten
order by count(sohd) desc
--III.41.Trong thang may 2006 thi doanh so la cao nhat
select month(nghd) Thang, SUM(TRIGIA)
from hoadon HD1
where year(nghd)='2006'
group by month(nghd)
HAVING SUM(TRIGIA)>=ALL (SELECT SUM(TRIGIA)
FROM HOADON HD2
WHERE  YEAR(NGHD)='2006'
GROUP BY MONTH(NGHD)
)
--III.42.Tim san pham co so luong thap nhat trong nam 2006
SELECT CTHD1.MASP, TENSP, SUM(SL)
FROM CTHD CTHD1,SANPHAM, HOADON
WHERE SANPHAM.MASP=CTHD1.MASP AND HOADON.SOHD=CTHD1.SOHD AND YEAR(NGHD)='2006'
GROUP BY CTHD1.MASP, TENSP
HAVING SUM(SL) <=ALL (SELECT SUM(SL)
FROM CTHD CTHD2, HOADON
WHERE CTHD2.SOHD=HOADON.SOHD
GROUP BY CTHD2.MASP
)
--43.Moi nuoc san xuat, tim san pham co gia ban cao nhat
select masp,tensp,nuocsx,gia
from sanpham a
where gia in (select max(gia)
from sanpham b
where a.NUOCSX=b.NUOCSX
group by nuocsx)
--44.Tim nuoc san xuat co it nhat 3 san pham co gia khac nhau
select nuocsx
from sanpham
group by nuocsx
having count(distinct gia)>=3
--45.Trong 10 khach hang co doanh so cao nhat, tim ra khach hang co so lan mua hang nhieu nhat
select *
from khachhang
where makh in (select khachhang.makh
from khachhang,hoadon
where khachhang.makh=hoadon.makh and doanhso in (select top 10 with ties doanhso
from khachhang
order by doanhso desc)
group by khachhang.makh
having count(sohd)>=(select top 1 with ties count(sohd)
from hoadon
group by makh
order by count(sohd) desc
)
)


